# Overrides for https://github.com/naturalis/puppet-role_waarneming

classes:
  - role_base::server_waarneming

# web
role_waarneming::conf::web_host: '127.0.0.1'
role_waarneming::conf::waarneming_key: undef
role_waarneming::conf::waarneming_crt: undef
role_waarneming::conf::waarneming_server_name: 'server_name'
role_waarneming::conf::observation_key: undef
role_waarneming::conf::observation_crt: undef
role_waarneming::conf::observation_server_name: '.observation.org'
role_waarneming::conf::wnimg_key: undef
role_waarneming::conf::wnimg_crt: undef
role_waarneming::conf::wnimg_server_name: '.wnimg.nl'
role_waarneming::conf::git_repo_key_php: undef
role_waarneming::conf::git_repo_key_django: undef
role_waarneming::conf::git_repo_url_php: 'ssh://git@bitbucket.org/zostera/waarneming.git'
role_waarneming::conf::git_repo_url_django: 'ssh://git@bitbucket.org/zostera/obs.git'
role_waarneming::conf::git_repo_rev_php: 'master'
role_waarneming::conf::git_repo_rev_django: 'master'

# db
role_waarneming::conf::db_host: '127.0.0.1'
role_waarneming::conf::db_name: 'waarneming'
role_waarneming::conf::postgresql_version: '9.5'
role_waarneming::conf::pgbouncer_port: 5432
role_waarneming::conf::waarneming_password: 'changeme'
role_waarneming::conf::local_be_password: 'changeme'
role_waarneming::conf::local_nl_password: 'changeme'
role_waarneming::conf::local_xx_password: 'changeme'
role_waarneming::conf::local_00_password: 'changeme'
role_waarneming::conf::hisko_password: 'changeme'
role_waarneming::conf::hugo_password: 'changeme'
role_waarneming::conf::obs_password: 'changeme'
role_waarneming::conf::analytics_password: 'changeme'

#db
role_waarneming::db::config_entries:
  max_connections:
    value: 150        # default: 100
  shared_buffers:
    value: '2GB'      # default: 128MB
  effective_cache_size:
    value: '4GB'      # default: 4GB
  max_stack_depth:
    value: '7680kB'
  temp_buffers:
    value: '16MB'
  work_mem:
    value: '16MB'
  maintenance_work_mem:
    value: '2GB'
  sort_mem:
    value: '64MB'
  random_page_cost:
    value: 2
  track_activity_query_size:
    value: 8192
  shared_preload_libraries:
    value: 'pg_stat_statements'
  pg_stat_statements.track:
    value: 'all'

# Analytics
role_cron::cron_job_hash:

  pg_stat_all_tables:
    minute: '*/1'
    command: "psql postgresql://analytics:changeme@localhost/postgres -f /opt/postgresql/pg_stat_all_tables.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_all_tables.json"

  pg_statio_all_tables:
    minute: '*/1'
    command: "psql postgresql://analytics:changeme@localhost/postgres -f /opt/postgresql/pg_statio_all_tables.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_statio_all_tables.json"
 
  pg_stat_statements:
    minute: '*/1'
    command: "psql postgresql://analytics:changeme@localhost/postgres -f /opt/postgresql/pg_stat_statements.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_statements.json"

  pg_stat_database:
    minute: '*/1'
    command: "psql postgresql://analytics:changeme@localhost/postgres -f /opt/postgresql/pg_stat_database.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_database.json"
 
  pg_stat_activity:
    minute: "*/1"
    command: "psql postgresql://analytics:6ce4ee95-6e53@localhost/waarneming -f /opt/postgresql/pg_stat_activity.sql head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_activity.json"
 
  iostat:
    minute: '*/1'
    command: "/bin/bash /opt/postgresql/iostat.sh"
 
 
 # Filebeat
 filebeat::prospectors:
  syslog:
    paths:
      - '/var/log/postgresql/postgresql-9.5-main.log'
    doc_type: 'pq_syslog'
  pg_stat_statements:
    paths:
      - '/var/log/postgresql/pg_stat_statements.json'
    doc_type: 'pg_stat_statements'
    json:
      keys_under_root: true
  pg_stat_database:
    paths:
      - '/var/log/postgresql/pg_stat_database.json'
    doc_type: 'pg_stat_database'
    json:
      keys_under_root: true
  pg_stat_all_tables:
    paths:
      - '/var/log/postgresql/pg_stat_all_tables.json'
    doc_type: 'pg_stat_all_tables'
    json:
      keys_under_root: true
  pg_statio_all_tables:
    paths:
      - '/var/log/postgresql/pg_statio_all_tables.json'
    doc_type: 'pg_statio_all_tables'
    json:
      keys_under_root: true
  iostat:
    paths:
      - "/var/log/postgresql/iostat.plain"
    doc_type: iostat
filebeat::outputs:
  logstash:
    hosts:
      - '127.0.0.1:5044'
