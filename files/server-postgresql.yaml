classes:
  - role_postgresql

# Install settings
role_postgresql::listen_address: '*'

# Databases
role_postgresql::db_hash:
  drupaldb:
    user: 'drupal_user'
    password: 'password'

# Roles
role_postgresql::role_hash:
  drupal:
    user: 'drupal_user'
    password: 'password'
  analytics:
    user: 'analytics'
    password: 'password'
    superuser: true

# Grants
role_postgresql::grant_hash:
  drupal:
    privilege: 'ALL'
    db: 'drupaldb'
    role: 'drupal'

# Remote connections
role_postgresql::pg_hba_rule_hash:
  all:
    description: 'Allow all'
    type: 'host'
    database: 'drupaldb'
    user: 'drupal_user'
    address: '0.0.0.0/0'
    auth_method: 'md5'

# Configure options in postgresql.conf
role_postgresql::config_values:
  logging_collector: 'on'
  log_destination: 'csvlog'
  log_min_messages: 'DEBUG5'
  log_rotation_age: '1d'
  log_rotation_size: '1GB'
  log_directory: '/var/log/postgresql'

# Cron jobs for analytics
role_postgresql::cron_job_hash:
  pg_stat_all_tables:
    minute: "*/1"
    command: psql postgresql://analytics:password@localhost/drupaldb -f /opt/postgresql/pg_stat_all_tables.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_all_tables.json
  pg_statio_all_tables:
    minute: "*/1"
    command: psql postgresql://analytics:password@localhost/drupaldb -f /opt/postgresql/pg_statio_all_tables.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_statio_all_tables.json
  pg_stat_statements:
    minute: "*/60"
    command: psql postgresql://analytics:password@localhost/drupaldb -f /opt/postgresql/pg_stat_statements.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_statements.json
  pg_stat_database:
    minute: "*/1"
    command: psql postgresql://analytics:password@localhost/postgres -f /opt/postgresql/pg_stat_database.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_database.json
  pg_stat_activity:
    minute: "*/1"
    command: psql postgresql://analytics:password@localhost/drupaldb -f /opt/postgresql/pg_stat_activity.sql | head -n-2 | tail -n+3 | jq -c . >> /var/log/postgresql/pg_stat_activity.json
  iostat:
    minute: "*/1"
    command: "/bin/bash /opt/postgresql/iostat.sh"
