# Set up LAMP stack for Drupal
classes:
  - role_apache
  - role_mysql
  - role_php

# Apache
role_apache::vhosts_hash:
  drupal:
    directoryindex: 'index.php index.htm index.html'
    docroot: '/var/www/drupal'
    docroot_owner: 'www-data'
    docroot_group: 'www-data'
    override: 'ALL'
    servername: 'default'
    serveraliases:
      - 'root.*.lh'
    virtual_docroot: '/var/www/%2'

# MySQL root_password
role_mysql::mysql_root_password: 'mypass'
# MySQL override_options
role_mysql::override_options:
  mysqld:
    bind-address: '0.0.0.0'
    max_allowed_packet: '512M'
# MySQL users
role_mysql::users:
  'drupal@localhost':
    ensure: 'present'
    password: 'mypass'
  'drupal@%':
    ensure: 'present'
    password: 'mypass'
# MySQL grants
role_mysql::grants:
  'drupal@localhost/drupaldb.*':
    privileges:
      - ALL
    table: 'drupaldb.*'
    user: 'drupal@localhost'
  'drupal@%/drupaldb.*':
    privileges:
      - ALL
    table: 'drupaldb.*'
    user: 'drupal@%'
# MySQL create databases with extra user
role_mysql::db_hash:
  drupaldb:
    user: 'manager'
    password: 'mypass'
    host: 'localhost'
    grant:
      - SELECT

# PHP settings
role_php::settings:
   PHP/max_execution_time: '90'
   PHP/max_input_time: '300'
   PHP/memory_limit: '128M'
   PHP/post_max_size: '32M'
   PHP/upload_max_filesize: '32M'
   PHP/allow_url_fopen: 'Off'
   Date/date.timezone: 'Europe/Berlin'
# PHP extensions
role_php::extensions:
  bcmath: {}
  xmlrpc: {}
  gd: {}
  mysql: {}
  imagick:
    provider: pecl
  apc:
    provider: pecl
    settings:
      'apc/stat': 1
      'apc/stat_ctime': 1
    sapi: 'fpm'
